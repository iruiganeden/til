各ブロックの役割とポイント
1. Prod VNet / Test VNet（環境分離）
それぞれ別アドレス空間、別サブスクリプションにしてもOK（セキュリティ/請求分離を強化できる設計）。
サブネット例:
subnet-app-prod
subnet-app-test
NSG (Network Security Group) は環境ごとに定義し、相互到達を禁止。
たとえば Test から Prod への東西トラフィックはルート・NSGで拒否。

2. Azure VM（アプリケーションサーバ）
Webアプリ / API / バッチなどを稼働。
拠点内公開やインターネット公開が必要な場合は、それぞれのVNet側に
Internal Load Balancer（社内向け）
Public Load Balancer / App Gateway（インターネット向け）
を追加する形になる。
（今回要件に明記がないので図では省略しているが、後段で足せるように分離済み）

3. Azure Monitor（環境ごと）
VMのメトリクス（CPU、メモリ、ディスクIOなど）、可用性、ハートビートを収集。
アラートルール（例：CPU>80%が5分以上）を定義。
アラート発火時のAction Groupで「HTTP Webhook呼び出し先 = Azure Function」を指定する。
→ 要件「環境ごとに監視用のmonitorを構築」に対応。

4. Log Analytics Workspace（環境ごと）
OSログ、アプリログ、カスタムログ、診断ログを集約。
Prod用WorkspaceとTest用Workspaceを分けることで、
ログ閲覧権限（RBAC）を環境単位に制御できる
保存期間/コストポリシーを変えられる（本番90日、テスト30日など）
Azure Monitorの多くの機能（ログベースアラートなど）もこのWorkspaceを参照する。
→ 要件「ログ監視を行うために、Log Analyticsを構築」に対応。

5. Hub VNet（共有サービスVNet）
監視連携・東西トラフィック制御・外部接続ポイントをまとめる場所。
Key要素:
ExpressRoute Gateway
オンプレの専用線とAzureをL3で接続するゲートウェイ。
Azure Function (アラート転送用)
Azure Monitor から飛んできたアラートペイロードを受け取り、
オンプレ監視システムの期待するJSON/XML/SNMP Trap相当などに変換して送信する。
セキュリティ要件が高いなら、この Function を App Service Environment / VNet Integration で Hub VNet 内に閉じ込める。
(任意) Azure Firewall / NVA
Prod/Test から Hub 経由で外に出る経路を一元管理したい場合に配置。
ルーティングは各VNetのUDRで Hub のFirewallにデフォルトルートを向ける設計にできる。
→ 要件「監視のアラート情報を外部NW経由で他監視システムに転送」「アラート情報の転送はAzure Functionを使用する」「外部NWはExpressRouteの専用線を使用する」に対応。

6. VNet Peering
Prod VNet ↔ Hub VNet
Test VNet ↔ Hub VNet
ピアリングにより、Prod/Test 側から Hub 内の Function / Firewall / ER Gateway に到達できる。
逆向きのアクセス制御やルート制御はNSG・UDR・Firewallで縛る。
「テスト環境から本番のアプリサーバへは一切行かせない」などのポリシーはここで実装。

4. Log Analytics Workspace（Prod: LAP / Test: LAT）
役割
各環境のログを集中管理する「ログ貯蔵＋検索＋分析」の基盤。
OSイベントログ / syslog / アプリケーションログ / ミドルウェアログ / 診断ログ など。
KQL（クエリ言語）でログを検索し、異常パターン検知やトレンド分析を行う。
ポイント
Prod用とTest用でワークスペースを分けることで:
アクセス権（RBAC）を分離できる
→ テスト担当者が本番ログを勝手に見れないようにできる。
保持期間を変えられる
→ 本番は90日保持、テストは30日保持などコスト最適化。
Azure Monitorの「ログベースアラート」の参照元にもなる（Log Analyticsのクエリ結果に閾値を設定してアラート化できる）。
将来の監査・障害解析の一次情報になるので、命名規約・保存ポリシー・アクセス権は運用設計書レベルで明文化しておくとよい。

5. Azure Monitor（Prod: MONP / Test: MONT）
役割
環境ごとの監視エンジン。
VMのメトリクス監視（CPU高負荷、ディスクフル、プロセス死活など）
ログベース監視（Log AnalyticsをKQLで監視し、特定のエラーログ急増などを検知）
アラートルールとAction Groupの定義
アラート発生時、Action Group から Webhook で通知を飛ばす。
ポイント
Prod用MonitorとTest用Monitorを分けることで、本番とテストでアラート閾値・通知先・運用フローを分離できる。
例：本番は24/365の一次監視チームを叩く、テストは開発チームのチャット通知に留める、など。
Log Analytics Workspace とつながっており、ログ由来のイベントも同じルートでアラート化できる。
「インフラ的な死活監視」と「アプリのログ異常監視」を同じ窓口にまとめられるのが大きい。
Action Group の送信先として Azure Function を指定し、標準アラート → カスタム形式に変換 → 社内監視基盤へ転送、というワークフローを統一できる。

6. Azure Function（アラート転送ロジック / Hub VNet 内）
役割
Azure Monitor の Action Group から受け取ったアラート通知（WebhookのJSONなど）を受信する。
監視チームやオンプレ監視システムが期待する形式（独自JSON、XML、Syslog擬似メッセージ、SNMP Trap相当 など）へ整形・マッピングする。
整形結果を専用線側（ExpressRoute側）に転送する「変換ゲートウェイ」。
ポイント
Function を Hub VNet 側に配置し、VNet統合/プライベートエンドポイント化しておくことで、インターネット非公開のルートにできる（セキュリティ・監査的に◎）。
Prod/TestどちらのアラートもこのFunctionに集約できるので、オンプレ側は「受け口を1本」持っていればよい。
可用性要件（落ちたら監視連携が止まる）をどう担保するかは検討ポイント
例: 冗長なFunctionインスタンス、キューイング（Storage Queue / Event Hub）を間に挟む、送信リトライなど。

7. ExpressRoute Gateway（ER / Hub VNet 内）
役割
Azureとオンプレミス（外部監視システム側）をL3レイヤで専用線接続するゲートウェイ。
インターネット経由ではなく閉域で監視アラートを届ける“専用回線の出口”。
ポイント
セキュリティ・コンプライアンス要件で「監視情報はインターネットを通さないこと」が必要な場合、この構成が説明できる。
Hub VNet に集約することで、Prod/Test 側はインターネット直結を持たずともオンプレ監視に通知できる。
ルート制御（UDR）とNSG/Firewallで、逆方向（オンプレ→Prod/Test）に余計な到達を許さないようにすることが重要。

8. Hub VNet（共有サービスVNet）
役割
共通インフラ系サービスを集約する“ハブ”ネットワーク。
Azure Function（アラート連携ロジック）
ExpressRoute Gateway（専用線出口）
（必要なら）Azure Firewall / NVA などのセキュリティ境界装置
Prod/Test の “スポークVNet” からピアリングで接続される中心点。
ポイント
ここを通してしかオンプレに出られないようにすると、経路・セキュリティログ・通信制御を一本化できる。
Azure Firewall / NVA をここに置くと、Prod/Testから外部（社内DC側含む）へのトラフィックを集約・検査できる。
運用面で「Hub管理チーム」と「アプリ運用チーム」を分けることもでき、権限分離・責任分離がしやすい。

9. VNet Peering（Prod ↔ Hub / Test ↔ Hub）
役割
Prod VNet と Hub VNet、Test VNet と Hub VNet をL3的に相互接続する機能。
これによって、Prod/Test 側の監視データやアラートが Hub 側のFunction・ExpressRoute 経由で外部に出られる。
ポイント
Peeringは基本的に同一リージョン内やサブスクリプションを跨いでも構成可能。運用組織ごとにサブスクを分ける案とも相性が良い。
Peeringはトラフィックを“ただつなぐ”だけなので、不要な経路・双方向アクセスまで開放しないように、NSG・UDR・Firewallで明示的に縛るのが設計のキモ。
Test→Prodみたいな横抜けを起こさないこと（監査で必ず聞かれるポイント）。

10. Azure Firewall / NVA（Hub内, 任意）
役割
East-West（Prod/Test ↔ Hub）、North-South（Hub ↔ オンプレ）双方の通信を検査・制御するセキュリティ境界。
監査／セキュリティ部門が「どこで通信をロギング・遮断できるのか？」と聞いてくる時の回答ポイントになる。
ポイント
“全トラフィックはまずHubのFirewallを通る”という形にしておくと、通信経路を一本化できる。
経路制御には UDR (User Defined Route) を使う。Appサブネット側の0.0.0.0/0や特定ネットワーク宛のNext HopをFirewallに向けることで、勝手なダイレクト通信を防げる。
セキュリティログはまたLog Analyticsに流せるので、通信ログを監査証跡として残せる。

11. 外部監視システム（NMS / On-prem側）
役割
既存の監視運用チームやSOC/NOCが使っている監視基盤（例: Zabbix相当、Netcool相当、独自運用基盤など）。
Azure側のアラートを最終的に統合・チケット化・エスカレーションする場所。
ポイント
Azure運用チームと既存NOC/SOCをつなぐハンドオフ地点になるので、アラートのフォーマット・重要度・タイトル規約・タイムゾーン・相関ルールなどを事前に握ることが超大事。
“どのアラートを本番向け扱いにするか” “テスト環境の通知はどこまで本番と同列扱いにするか” は運用プロセスの設計課題。
ExpressRoute経由で閉域受信することで、セキュアに統合できることを説明できる。
了解。VM上のWebアプリを前提に、「これは絶対見るべき」という監視項目を表でまとめます。
表は3つに分けます（①インフラ/性能 ②アプリ/ログ/可用性 ③監視基盤そのものの健全性）。

---

## ① VMインフラ / OSリソース系

| 監視カテゴリ      | 監視項目                                    | 説明・狙い                           | しきい値・アラート例（目安）                                                 | Azure側の実装イメージ                                                     |
| ----------- | --------------------------------------- | ------------------------------- | -------------------------------------------------------------- | ----------------------------------------------------------------- |
| CPU         | CPU使用率(平均/ピーク)                          | 過負荷やスパイクを検知。スケール不足や暴走プロセスの兆候になる | 5分平均が80%以上継続 / ピーク95%以上                                        | Azure Monitor メトリックアラート（VMのCPU%）＋Log AnalyticsのPerfテーブル           |
| メモリ         | メモリ使用率 / 空きメモリ量                         | メモリ枯渇はアプリ落ちやスワップ発生に直結           | 空きメモリ < 500MB、もしくは使用率90%以上が継続                                  | Azure Monitor Agentで収集したメモリPerfカウンターに対するログアラート/メトリックアラート          |
| ディスク容量      | ボリューム使用率 / 残り容量                         | 容量逼迫でアプリが書けなくなる（ログ出力も停止する）      | 使用率90%以上、または残り<5GBなど                                           | PerfテーブルのLogicalDisk系カウンターに対するログ検索アラート                            |
| ディスクI/O     | ディスク待ち行列長 / レイテンシ                       | ストレージボトルネックの早期発見。応答遅延の原因になりやすい  | キュー長が一定以上（例: >2〜3）で5分以上継続                                      | Perfから`Current Disk Queue Length`等を集計しログアラート                      |
| ネットワーク      | 送受信スループット / エラーパケット数                    | 帯域逼迫・NIC異常・DDoS的な急増などを検知        | エラーパケットが連続発生 / 送信量・受信量が平常時のx倍などの異常スパイク                         | VMメトリック（ネットワークIn/Out, パケットドロップ等）に対するメトリックアラート                     |
| プロセス/サービス稼働 | 必須プロセスの稼働有無 (例: nginx/httpd、アプリの常駐プロセス) | Webアプリの主プロセスが死んでいないか監視          | プロセス/サービスが停止したら即アラート                                           | VM Insights・Change Tracking/Inventory・カスタムスクリプト＋Log Analyticsへの記録 |
| OSイベントログ    | OSレベルの重大エラー/警告                          | カーネル/サービスクラッシュ、ドライバ異常、I/Oエラーの兆候 | Windows: EventLevel=Error発生時即アラート / Linux: syslog severity=err | DCRでWindows Event / Syslog収集→Log Analyticsのログ検索アラート               |
| セキュリティ系OSログ | 異常なログイン・認証失敗の連続                         | 不正アクセス/総当たり攻撃などの検知              | 同一IPから一定回数以上の失敗(例: 5分で10回以上)                                   | Syslog(Security)やWindows Securityログに対するKQL＋ログアラート                 |

---

## ② アプリケーション / 可用性 / 外形監視

| 監視カテゴリ       | 監視項目                           | 説明・狙い                                           | しきい値・アラート例（目安）                          | Azure側の実装イメージ                                                                           |                                             |
| ------------ | ------------------------------ | ----------------------------------------------- | --------------------------------------- | --------------------------------------------------------------------------------------- | ------------------------------------------- |
| アプリログ（Error） | アプリのエラーログ出力                    | Webアプリが吐くエラーレベルのログ。例外・スタックトレース・HTTP 5xx等を検知したい  | 「直近5分でErrorレベル1件以上」や「15分でErrorが50件以上」など | Azure Monitor Agent(AMA)のDCRでカスタムテキストログ収集 → Log Analyticsのカスタムテーブル(MyApp_CL)に対するログアラート  |                                             |
| アプリログ（業務コード） | 独自エラーコード/致命コード                 | ビジネス的に重大な失敗(例: 決済失敗、在庫更新失敗など)を素早く検知             | 特定コード(例: FATAL_XXX)が1回でも記録されたら即アラート     | KQLで`MyApp_CL                                                                           | where code=="FATAL_XXX"`の結果>0 をトリガーするログアラート |
| HTTP応答コード分布  | HTTP 5xx率 / 4xx急増              | ユーザー影響が直接出る障害。IIS/Nginx/アプリのアクセスログから検出          | 直近5分の総リクエスト中、5xxが5%以上など                 | IISログ(W3CIISLog)やNginxアクセスログを収集し、KQLで集計→ログアラート                                          |                                             |
| レイテンシ        | 応答時間(P95/P99)                  | 体感性能低下の早期検知。遅延増大は劣化やスローダウンの兆候                   | P95応答時間が通常比+50%以上、または閾値(例: >2秒)超過が継続    | Application Insightsの可用性/依存関係データ or アプリログ内応答時間の集計に対するログアラート                             |                                             |
| 外形監視(稼働確認)   | URL疎通チェック(HTTP 200/ヘルスチェックURL) | VMは生きていてもアプリが死んでるケースを検知。ユーザー視点の可用性              | ヘルスチェックURLがタイムアウト or 非2xx応答を1回検知で即アラート  | Application Insightsの可用性テスト(URL ping) or Azure Monitor/Logic AppsのHTTPチェック→メトリック/ログアラート |                                             |
| ポート疎通        | 443/80など公開ポートのリッスン監視           | TCPレベルで待ち受けているか。アプリプロセス死やFWの誤設定でLISTENが消えた場合を検知 | 監視対象ポート(例:443)が一定間隔で疎通不可になったら即アラート      | Network WatcherのConnection Monitorやカスタムスクリプト結果をLog Analyticsに送信→ログアラート                  |                                             |
| スループット       | リクエスト数/秒、同時コネクション数             | 突発的なスパイクや過負荷の前兆、DoS的な急増を検知                      | 平常時のx倍(例:通常の3倍以上)が続いたら注意                | Webサーバーログ(Nginx/IIS)やApp Insightsのrequests/secメトリックに対するメトリック/ログアラート                     |                                             |

---

## ③ 監視そのものの健全性（監視抜け防止）

| 監視カテゴリ          | 監視項目                         | 説明・狙い                                                   | しきい値・アラート例（目安）                                    | Azure側の実装イメージ                                                        |
| --------------- | ---------------------------- | ------------------------------------------------------- | ------------------------------------------------- | -------------------------------------------------------------------- |
| VM稼働状態 / 可用性    | VMが実行中か (可用性メトリック)           | そもそもVMが落ちていないか。サブスクリプション/リソースグループ単位で横断的に把握              | VMステータスがStopped/Unavailableになったら即アラート             | Azure Monitorメトリック「可用性(稼働状態)」に対するメトリックアラート（複数VMを1ルールで監視）             |
| エージェントHeartbeat | Log Analytics Heartbeatの有無   | 監視エージェント(AMA)が死んでいないか、ログ送信が止まっていないかを検知                  | Heartbeatが5分以上途絶 → アラート                           | Log AnalyticsのHeartbeatテーブルに対するログ検索アラート                              |
| ログ収集の遅延/欠損      | 重要テーブル(例: MyApp_CL)の最新レコード時刻 | アプリログが取り込まれているか。アプリは動いてるのにログがまったく入ってこない＝収集経路が壊れてる       | 「MyApp_CLの最新ログが30分以上更新なし」でアラート                    | KQLで‘最新TimeGenerated’をチェックし、一定時間以上レコードなしなら通知するログアラート                 |
| データ量の急増         | ログインジェスト量の異常増大               | ログ暴走（無限ループ等）や攻撃（大量404/500）によるログスパムを検知し、ストレージ圧迫やコスト爆発を防ぐ | 直近15分のレコード件数が通常のx倍（例: 10倍）                        | Log Analyticsでテーブルごとのcount()を定期集計し、異常値ならログアラート                       |
| アラート配信経路        | Webhook / Function応答ステータス    | 外部監視サービスへの連携が壊れていないか。通知自体が落ちていれば本番障害を見逃す危険がある           | Azure Function側で外部送信に失敗(非2xx)したらエラーログ出力→そのログでアラート | Azure Function内でエラーログを書き、FunctionのログをLog Analyticsに送信→ログアラート（転送失敗監視） |
| 監視対象の網羅性        | 未監視VM/未適用DCRの検出              | 新しく作ったVMに監視エージェント/DCRが入ってない「監視漏れ」を検知                    | エージェント未導入VMがサブスク内に存在したらアラート                       | Azure Policy＋ログ収集 (準拠してないリソース一覧を定期出力)をLog Analyticsに蓄積→ログアラートで検知     |

---

### 使い方イメージ

* ①と②は「ユーザー影響を直接生むもの」（リソース逼迫、アプリの落ち、応答遅延、5xx急増）。
* ③は「監視が機能しなくなる状態」（エージェント止まった、Webhook壊れた、監視漏れ）を拾うもの。

この3レイヤを押さえておけば、「サーバーは元気？」「アプリは返してる？」「その監視はちゃんと届いてる？」をすべてカバーできます。


